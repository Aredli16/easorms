FROM node:20.9-alpine

#ENV NODE_ENV=production : Causes error on build
ARG KEYCLOAK_CLIENT_ID
RUN test -n "${KEYCLOAK_CLIENT_ID}"
ARG KEYCLOAK_CLIENT_SECRET
RUN test -n "${KEYCLOAK_CLIENT_SECRET}"
ARG KEYCLOAK_ISSUER
RUN test -n "${KEYCLOAK_ISSUER}"
ARG NEXTAUTH_SECRET
RUN test -n "${NEXTAUTH_SECRET}"
ARG NEXTAUTH_URL
RUN test -n "${NEXTAUTH_URL}"
ARG API_URL
RUN test -n "${API_URL}"
ARG NEXT_PUBLIC_API_URL
RUN test -n "${NEXT_PUBLIC_API_URL}"

WORKDIR /app

COPY package.json yarn.lock ./

RUN yarn install

COPY . .

ENV KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID}
ENV KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
ENV KEYCLOAK_ISSUER=${KEYCLOAK_ISSUER}
ENV NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
ENV NEXTAUTH_URL=${NEXTAUTH_URL}
ENV API_URL=${API_URL}
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}

RUN yarn build

EXPOSE 3000

CMD ["yarn", "start"]
